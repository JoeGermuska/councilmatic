{% extends "base.html" %}
{% load url from future %}
{% load i18n %}
{% load compress %}
{% load cache %}

{% block load_early %}
{% endblock %}

{% block content %}
<div class="councilmember-detail dashboard">
  <div class='row-fluid'>
    <div class='offset1 span10'>
      <div class="content">
        <div class="row-fluid">
          <img class='span2 img-polaroid' alt="{{ councilmember.name }}" src="{{STATIC_URL}}{{ councilmember.headshot }}">
          <div class='span8'>
            <h1>
              {{ councilmember.name }}
              <small><br />{{ councilmember.title }}</small>
            </h1>

            {% include 'subscriptions/subscribe_form.html' with subscribe_text=_('Follow this person') unsubscribe_text=_('Stop following this person') %}

          </div>

        </div>
        <hr />

        <div class="row-fluid">
          <!------------------------------------------------------
            -- The council member's recently sponsored legislation
            -->
          <div id="dashboard_legislation" class="councilmember-legislation span6">
            <h2>{% trans "Recent Legislation" %}</h2>

            {% include "councilmatic/partials/legfile_list.html" %}

            <a href="{% url 'search' %}?sponsors={{ councilmember.name }}">{% trans "More..." %}</a>
          </div>

          <!-------------------------------------------------------
            -- The council member's district geograph(y/ies)
            -->
          <script type="text/javascript"
              src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
          <script src="{{ STATIC_URL}}libs/GeoJSON.js"></script>

          <div class="councilmember-tenures span6">
            {% for tenure in councilmember.tenures.all %}
            <div class="councilmember-districts">
              <h2>
              {% if tenure.at_large %}
                {% trans "At Large" %}
              {% else %}
                {% blocktrans %}Representing District {{ tenure.district.id }}{% endblocktrans %}
              {% endif %}

              {% if tenure.president %}
                <br>{% trans "Serving as Council President" %}
              {% endif %}
              </h2>

              {% if tenure.end %}
                <h3>{% blocktrans %}From {{ tenure.begin }} until {{ tenure.end }}{% endblocktrans %}</h3>
              {% else %}
                <h3>{% blocktrans %}Since {{ tenure.begin }}{% endblocktrans %}</h3>
              {% endif %}

              {% if not tenure.at_large %}
                <div class="map-wrapper">
                  <div id="tenure-{{ tenure.pk }}-map" class="tenure-map">
                  </div>
                </div>

                <script type="text/javascript">
                  var map;
                  var initialize = function() {
                    var myOptions = {
                          zoom: 10,
                          center: new google.maps.LatLng(40.006054, -75.147858),
                          mapTypeId: google.maps.MapTypeId.ROADMAP
                        },
                        latlngs = [];

                    map = new google.maps.Map(document.getElementById('tenure-{{ tenure.pk }}-map'),
                        myOptions);

                    var districtOptions = {
                        map: map,
                        title: "District {{ tenure.district.id }}"
                    }
                    var districtVector = new GeoJSON({{ tenure.district.shape.json|default:'{ "type": "Polygon", "coordinates": [] }'|safe }}, districtOptions);
                    zoomToFitVector(map, districtVector.getPath())
                  };

                  var zoomToFitVector = function(map, path) {
                    //  Create a new viewpoint bound
                    var bounds = new google.maps.LatLngBounds ();
                    //  Go through each...
                    for (var i = 0, numlatlngs = path.b.length; i < numlatlngs; i++) {
                      //  And increase the bounds to take this point
                      bounds.extend (path.b[i]);
                    }
                    //  Fit these bounds to the map
                    map.fitBounds (bounds);
                  };

                  google.maps.event.addDomListener(window, 'load', initialize);
                </script>
              {% endif %}

              <hr>

            </div> <!-- .councilmember-districts -->
            {% endfor %}

            <h2>Sponsored legislation by topic</h2>
            <div class='accordion' id='view_accordion'>
              {% cache 1800 recent_topics councilmember %}
              {% for topic in recent_topics %}
                <div class='accordion-group'>
                  <div class='accordion-heading'>
                    {% if topic.children %}
                      <a class='accordion-toggle pull-left' data-parent='#view_accordion' data-toggle='collapse' data-view='{{topic.topic}}' href='#category_{{topic.id}}'>
                        <i class='icon-plus'></i>
                      </a>
                    {% else %}
                      <a href='#' class='accordion-toggle pull-left'>
                        <i class='icon-none'></i>
                      </a>
                    {% endif %}
                    <h4><strong>{{topic.leg_count}}</strong> <a href='/search?q=&topics={{topic.topic}}&sponsors={{ councilmember.name }}'>{{topic.topic}}</a></h4>
                    <div class='clearfix'></div>
                  </div>
                  {% if topic.children %}
                    <div class='accordion-body collapse' id='category_{{topic.id}}'>
                      <div class='accordion-inner' id='category_inner_{{topic.id}}'>
                        <ul>
                        {% for child in topic.children %}
                          <li>
                            <strong>{{child.leg_count}}</strong> <a href='/search?q=&topics={{child.topic}}&sponsors={{ councilmember.name }}'>{{child.topic}}</a>
                            {% if child.children %}
                              <ul>
                              {% for second_child in child.children %}
                                <li><strong>{{second_child.leg_count}}</strong> <a href='/search?q=&topics={{second_child.topic}}&sponsors={{ councilmember.name }}'>{{second_child.topic}}</a></li>
                              {% endfor%}
                              </ul>
                            {% endif %}
                          </li>
                        {% endfor%}
                        </ul>
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
              {% endcache %}

          </div> <!-- .councilmember-tenures -->

        </div> <!-- .row-fluid -->

      </div>
    </div>
    {% endblock %}
  </div>
</div>

{% block load_late %}
{% endblock %}
